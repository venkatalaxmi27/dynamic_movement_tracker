<!DOCTYPE html>
<html>
<head>
  <title>Vehicle Route with Real-Time Tracking</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    #map {
      height: 75vh;
      width: 100%;
    }
    #controls {
      padding: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    input {
      padding: 8px;
      width: 280px;
    }
    button {
      padding: 8px 20px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #388e3c;
    }
    #info {
      text-align: center;
      font-family: Arial;
      margin-bottom: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="pickup" type="text" placeholder="Pickup Location (Click to use current location)" readonly />
    <input id="drop" type="text" placeholder="Enter Drop Location" />
    <button onclick="calculateRoute()">Start Ride</button>
    <button onclick="stopTracking()">Stop Ride</button>
  </div>

  <div id="info">
    <span id="distance"></span> | <span id="duration"></span>
  </div>

  <div id="map"></div>

  <script>
    let map, directionsService, directionsRenderer, vehicleMarker;
    let dropAutocomplete;
    let watchId = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 17.385, lng: 78.4867 }, // Hyderabad default
        zoom: 13,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      dropAutocomplete = new google.maps.places.Autocomplete(document.getElementById("drop"));

      const pickupInput = document.getElementById("pickup");
      pickupInput.addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const latlng = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              const geocoder = new google.maps.Geocoder();
              geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                  pickupInput.value = results[0].formatted_address;

                  map.setCenter(latlng);
                  map.setZoom(15);

                  if (vehicleMarker) vehicleMarker.setMap(null);
                  vehicleMarker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    icon: {
                      url: "https://img.icons8.com/color/48/car-top-view.png",
                      scaledSize: new google.maps.Size(40, 40),
                    },
                  });
                } else {
                  alert('Could not determine your address from location.');
                }
              });
            },
            (error) => {
              alert('Error getting location: ' + error.message);
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      });
    }

    function calculateRoute() {
      const pickup = document.getElementById("pickup").value;
      const drop = document.getElementById("drop").value;

      if (!pickup || !drop) {
        alert("Please enter both pickup and drop locations.");
        return;
      }

      directionsService.route(
        {
          origin: pickup,
          destination: drop,
          travelMode: google.maps.TravelMode.DRIVING,
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);

            const leg = response.routes[0].legs[0];
            document.getElementById("distance").innerText = "Distance: " + leg.distance.text;
            document.getElementById("duration").innerText = "ETA: " + leg.duration.text;

            if (watchId !== null) {
              navigator.geolocation.clearWatch(watchId);
            }

            watchId = navigator.geolocation.watchPosition(
              (position) => {
                const latlng = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };

                if (!vehicleMarker) {
                  vehicleMarker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    icon: {
                      url: "https://img.icons8.com/color/48/car-top-view.png",
                      scaledSize: new google.maps.Size(40, 40),
                    },
                  });
                } else {
                  vehicleMarker.setPosition(latlng);
                }

                map.panTo(latlng);
              },
              (error) => {
                alert("Error tracking location: " + error.message);
              },
              {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000,
              }
            );
          } else {
            alert("Directions request failed: " + status);
          }
        }
      );
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        alert("Tracking stopped.");
      }
    }

    window.initMap = initMap;
  </script>

  <!-- âœ… Google Maps API with Your Key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZAU88Lr8CEkiFP_vXpkbnu1-g-PRigXU&libraries=drawing,geometry,places&callback=initMap" async defer></script>
</body>
</html>
